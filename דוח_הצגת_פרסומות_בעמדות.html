<!DOCTYPE html>
<html lang="he" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>דוח מחשבים פעילים לפי חנות - Safer</title>

    <!-- Bootstrap RTL -->
    <link rel="stylesheet" href="https://cdn.rtlcss.com/bootstrap/v4.5.3/css/bootstrap.min.css"
        integrity="sha384-JvExCACAZcHNJEc7156QaHXTnQL3hQBixvj5RV5buE7vgnNEzzskDtx9NQ4p6BJe" crossorigin="anonymous">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Custom CSS -->
    <style>
        /* RTL Support */
        body {
            direction: rtl;
            text-align: right;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        /* Card Enhancements */
        .card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease-in-out;
        }

        .card:hover {
            transform: translateY(-2px);
        }

        .card-header {
            border-bottom: 1px solid #e9ecef;
            background-color: #f8f9fa;
            border-radius: 10px 10px 0 0 !important;
        }

        /* Table Enhancements */
        .table {
            margin-bottom: 0;
        }

        .table thead th {
            border-top: none;
            border-bottom: 2px solid #dee2e6;
            font-weight: 600;
            color: #495057;
            background-color: #f8f9fa;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .table tbody tr:hover {
            background-color: #f8f9fa;
        }

        /* Button Enhancements */
        .btn {
            border-radius: 5px;
            font-weight: 500;
            transition: all 0.2s ease-in-out;
        }

        .btn:hover {
            transform: translateY(-1px);
        }

        /* Badge Enhancements */
        .badge {
            font-size: 0.85em;
            padding: 0.4em 0.6em;
        }

        /* Store and Branch Name Display */
        .store-name, .branch-name {
            font-weight: 600;
            color: #495057;
        }

        .store-id, .branch-id {
            font-size: 0.85em;
            color: #6c757d;
        }

        /* Filter Label */
        .filter-label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 0.5rem;
        }

        /* Statistics Cards */
        .stats-card {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            border: none;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .stats-card .card-body {
            padding: 1.5rem;
        }

        .stats-number {
            font-size: 2rem;
            font-weight: bold;
        }

        .stats-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        /* Active Computer Indicator */
        .active-computer {
            background-color: #d4edda !important;
            border-left: 4px solid #28a745;
        }

        .inactive-computer {
            background-color: #f8d7da !important;
            border-left: 4px solid #dc3545;
        }

        /* Export Button */
        .export-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            border: none;
            color: white;
            border-radius: 5px;
            font-weight: 500;
            transition: all 0.2s ease-in-out;
        }

        .export-btn:hover {
            background: linear-gradient(135deg, #218838 0%, #1ea085 100%);
            color: white;
            transform: translateY(-1px);
        }

        /* Filter Label */
        .filter-label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 0.5rem;
        }

        /* Progress Bar */
        .progress {
            background-color: #e9ecef;
            border-radius: 10px;
        }

        .progress-bar {
            border-radius: 10px;
        }
    </style>
</head>

<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="text-center text-white">
            <div class="spinner-border" role="status">
                <span class="sr-only">טוען...</span>
            </div>
            <div class="mt-2">טוען נתונים...</div>
        </div>
    </div>

    <div class="container-fluid" ng-app="adsReportsApp" ng-controller="AdsReportsController">
        <!-- Header -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body text-center">
                        <h1 class="mb-0">
                            <i class="fas fa-chart-line text-primary me-2"></i>
                            דוח מחשבים פעילים לפי חנות
                        </h1>
                        <p class="text-muted mt-2 mb-0">סטטיסטיקות מחשבים פעילים ברמת חנות</p>
                                                                    <div class="mt-3">
                                                <a href="index.html" class="btn btn-outline-primary me-2">
                                                    <i class="fas fa-arrow-right me-2"></i>
                                                    חזרה לדף הראשי
                                                </a>
                                                <button class="btn btn-outline-success" ng-click="refreshData()" ng-disabled="loading">
                                                    <i class="fas fa-sync-alt me-2" ng-class="{'fa-spin': loading}"></i>
                                                    רענן נתונים
                                                </button>
                                            </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Statistics Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="card-body text-center">
                        <div class="stats-number">{{getTotalStores()}}</div>
                        <div class="stats-label">חנויות</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="card-body text-center">
                        <div class="stats-number">{{getTotalActiveComputers()}}</div>
                        <div class="stats-label">מחשבים פעילים</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="card-body text-center">
                        <div class="stats-number">{{getTotalInactiveComputers()}}</div>
                        <div class="stats-label">מחשבים לא פעילים</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="card-body text-center">
                        <div class="stats-number">{{getAverageActiveComputersPerStore()}}</div>
                        <div class="stats-label">ממוצע מחשבים פעילים לחנות</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-filter me-2"></i>פילטרים</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <label class="filter-label">חנות:</label>
                                <select class="form-control" ng-model="storeFilter" ng-change="applyFilters()">
                                    <option value="">כל החנויות</option>
                                    <option ng-repeat="store in getUniqueStores()" value="{{store}}">{{getStoreName(store)}}</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="filter-label">סטטוס מחשב:</label>
                                <select class="form-control" ng-model="computerStatusFilter" ng-change="applyFilters()">
                                    <option value="">כל המחשבים</option>
                                    <option value="active">מחשבים פעילים בלבד</option>
                                    <option value="inactive">מחשבים לא פעילים בלבד</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="filter-label">פעולות:</label>
                                <div class="mt-2">
                                    <button class="btn btn-outline-secondary btn-sm me-2" ng-click="clearFilters()">
                                        <i class="fas fa-times me-1"></i>נקה פילטרים
                                    </button>
                                    <button class="btn export-btn btn-sm" ng-click="exportToExcel()">
                                        <i class="fas fa-file-excel me-1"></i>ייצא לאקסל
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Active Computers Report Table -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-table me-2"></i>
                            דוח מחשבים פעילים לפי חנות
                        </h5>
                        <div>
                            <span class="badge badge-info">{{getFilteredStoresCount()}} חנויות</span>
                            <span class="badge badge-success">{{getFilteredActiveComputersCount()}} מחשבים פעילים</span>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th style="cursor: pointer;" ng-click="sortBy('storeId')">
                                            <i class="fas fa-sort"></i> חנות
                                        </th>
                                        <th style="cursor: pointer;" ng-click="sortBy('totalComputers')">
                                            <i class="fas fa-sort"></i> סך מחשבים
                                        </th>
                                        <th style="cursor: pointer;" ng-click="sortBy('activeComputers')">
                                            <i class="fas fa-sort"></i> מחשבים פעילים
                                        </th>
                                        <th style="cursor: pointer;" ng-click="sortBy('inactiveComputers')">
                                            <i class="fas fa-sort"></i> מחשבים לא פעילים
                                        </th>
                                        <th style="cursor: pointer;" ng-click="sortBy('activePercentage')">
                                            <i class="fas fa-sort"></i> אחוז פעילות
                                        </th>
                                        <th>פרטים</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr ng-if="filteredStoresData.length === 0">
                                        <td colspan="6" class="text-center py-4">
                                            <div class="alert alert-info">
                                                <i class="fas fa-info-circle me-2"></i>
                                                <strong>אין נתונים להצגה.</strong><br>
                                                <small class="text-muted">
                                                    כדי לראות נתונים, פתח את הדף הראשי, טען נתונים, ולחץ על "דוח מחשבים פעילים לפי חנות"
                                                </small><br>
                                                <button class="btn btn-sm btn-outline-primary ms-2 mt-2" ng-click="refreshData()">
                                                    <i class="fas fa-sync-alt me-1"></i>
                                                    רענן נתונים
                                                </button>
                                                <a href="index.html" class="btn btn-sm btn-outline-success ms-2 mt-2">
                                                    <i class="fas fa-home me-1"></i>
                                                    לך לדף הראשי
                                                </a>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr ng-repeat="store in filteredStoresData | orderBy: sortField: sortReverse" 
                                        ng-class="{'active-computer': store.activeComputers > 0, 'inactive-computer': store.activeComputers === 0}">
                                        <td>
                                            <strong>{{getStoreName(store.storeId)}}</strong>
                                        </td>
                                        <td>
                                            <span class="badge badge-primary">{{store.totalComputers}}</span>
                                        </td>
                                        <td>
                                            <span class="badge badge-success">{{store.activeComputers}}</span>
                                        </td>
                                        <td>
                                            <span class="badge badge-danger">{{store.inactiveComputers}}</span>
                                        </td>
                                        <td>
                                            <div class="progress" style="height: 20px;">
                                                <div class="progress-bar bg-success" 
                                                     ng-style="{'width': store.activePercentage + '%'}"
                                                     role="progressbar">
                                                    {{store.activePercentage}}%
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <button class="btn btn-sm btn-outline-info" 
                                                    ng-click="showStoreDetails(store.storeId)"
                                                    ng-if="store.totalComputers > 0">
                                                <i class="fas fa-eye"></i> פרטים
                                            </button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Store Details Modal -->
        <div class="modal fade" id="storeDetailsModal" tabindex="-1" role="dialog">
            <div class="modal-dialog modal-lg" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">פרטי מחשבים - {{getStoreName(selectedStoreId)}}</h5>
                        <button type="button" class="close" data-dismiss="modal">
                            <span>&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>מזהה מחשב</th>
                                        <th>סניף</th>
                                        <th>טעינות</th>
                                        <th>תזוזות עכבר</th>
                                        <th>סטטוס</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr ng-repeat="computer in getStoreComputers(selectedStoreId)" 
                                        ng-class="{'active-computer': isComputerActive(computer), 'inactive-computer': !isComputerActive(computer)}">
                                        <td>
                                            <span class="badge badge-info">{{computer.computerId}}</span>
                                        </td>
                                        <td>{{getBranchName(computer.branchId)}}</td>
                                        <td>{{computer.totalLoadings}}</td>
                                        <td>{{computer.mouseMoves}}</td>
                                        <td>
                                            <span ng-if="isComputerActive(computer)" class="badge badge-success">פעיל</span>
                                            <span ng-if="!isComputerActive(computer)" class="badge badge-danger">לא פעיל</span>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">סגור</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.rtlcss.com/bootstrap/v4.5.3/js/bootstrap.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.9/angular.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- Embedded Stores Database -->
    <script>
        // Embedded stores database - using the same data from main app
        window.storesDatabase = [
            {
              "storeId": 422,
              "storeName": "Kiosk-MB",
              "branches": [
                {
                  "branchId": 645,
                  "branchName": "Kiosk-MB"
                }
              ]
            },
            {
              "storeId": 418,
              "storeName": "ראו שלום",
              "branches": [
                {
                  "branchId": 636,
                  "branchName": "ראו שלום"
                }
              ]
            },
            {
              "storeId": 407,
              "storeName": "Safe Click",
              "branches": [
                {
                  "branchId": 617,
                  "branchName": "Passaic"
                },
                {
                  "branchId": 607,
                  "branchName": "Safe Click"
                }
              ]
            },
            {
              "storeId": 135,
              "storeName": "אופיס",
              "branches": [
                {
                  "branchId": 220,
                  "branchName": "אופיס שמאי 4"
                },
                {
                  "branchId": 56,
                  "branchName": "אופיס התנאים 2"
                },
                {
                  "branchId": 53,
                  "branchName": "אופיס ריינט חטיבת הנגב 33 -41"
                },
                {
                  "branchId": 439,
                  "branchName": "התנאים 2 גברים"
                },
                {
                  "branchId": 57,
                  "branchName": "ריינט V.I.P"
                },
                {
                  "branchId": 55,
                  "branchName": "אופיס ריינט האדמו\"ר מבעלזא 4-6"
                }
              ]
            }
        ];
    </script>

    <!-- Main Application Script -->
    <script>
        angular.module('adsReportsApp', [])
        .controller('AdsReportsController', function($scope, $http) {
            
            // Initialize variables
            $scope.actions = [];
            $scope.storesData = [];
            $scope.computersData = [];
            $scope.filteredStoresData = [];
            
            // Filters
            $scope.storeFilter = '';
            $scope.computerStatusFilter = '';
            
            // Sorting
            $scope.sortField = 'activeComputers';
            $scope.sortReverse = true;
            
            // Modal
            $scope.selectedStoreId = null;
            
            // Load stores database
            $scope.loadStoresDatabase = function() {
                $scope.storesDatabase = window.storesDatabase || [];
                $scope.storeNamesMap = {};
                $scope.branchNamesMap = {};
                
                $scope.storesDatabase.forEach(function(store) {
                    $scope.storeNamesMap[store.storeId] = store.storeName;
                    if (store.branches) {
                        store.branches.forEach(function(branch) {
                            $scope.branchNamesMap[branch.branchId] = branch.branchName;
                        });
                    }
                });
                console.log('Stores database loaded successfully from embedded data');
            };
            
            // Get store name
            $scope.getStoreName = function(storeId) {
                const storeName = $scope.storeNamesMap[storeId];
                return storeName ? `${storeId} - ${storeName}` : `חנות ${storeId}`;
            };
            
            // Get branch name
            $scope.getBranchName = function(branchId) {
                const branchName = $scope.branchNamesMap[branchId];
                return branchName ? `${branchId} - ${branchName}` : `סניף ${branchId}`;
            };
            
            // Check if computer is active (at least 5 loadings and 5 mouse movements)
            $scope.isComputerActive = function(computer) {
                return (computer.totalLoadings >= 5) && (computer.mouseMoves >= 5);
            };
            
            // Process computers data
            $scope.processComputersData = function() {
                try {
                    if (!$scope.actions || $scope.actions.length === 0) {
                        $scope.computersData = [];
                        return;
                    }
                    
                    const computersMap = new Map();
                    
                    // Process loading actions (type 4)
                    const loadingActions = $scope.actions.filter(action => {
                        let actionType = action.actionType || action.type;
                        return actionType === 4 || actionType === '4';
                    });
                    
                    // Process mouse move actions (type 2)
                    const mouseMoveActions = $scope.actions.filter(action => {
                        let actionType = action.actionType || action.type;
                        return actionType === 2 || actionType === '2';
                    });
                    
                    // Process loading actions
                    loadingActions.forEach(action => {
                        let storeBranchComputer = action.source || '';
                        storeBranchComputer = String(storeBranchComputer).replace(/[()]/g, '');
                        let parts = storeBranchComputer.split('_');
                        
                        if (parts.length >= 3) {
                            let storeId = parts[0];
                            let branchId = parts[1];
                            let computerId = parts[2];
                            let key = `${storeId}_${branchId}_${computerId}`;
                            
                            if (!computersMap.has(key)) {
                                computersMap.set(key, {
                                    storeId: storeId,
                                    branchId: branchId,
                                    computerId: computerId,
                                    totalLoadings: 0,
                                    mouseMoves: 0,
                                    firstDate: null,
                                    lastDate: null
                                });
                            }
                            
                            let computer = computersMap.get(key);
                            computer.totalLoadings++;
                            
                            let actionDate = new Date(action.created_at);
                            if (!computer.firstDate || actionDate < new Date(computer.firstDate)) {
                                computer.firstDate = action.created_at;
                            }
                            if (!computer.lastDate || actionDate > new Date(computer.lastDate)) {
                                computer.lastDate = action.created_at;
                            }
                        }
                    });
                    
                    // Process mouse move actions
                    mouseMoveActions.forEach(action => {
                        let storeBranchComputer = action.source || '';
                        storeBranchComputer = String(storeBranchComputer).replace(/[()]/g, '');
                        let parts = storeBranchComputer.split('_');
                        
                        if (parts.length >= 3) {
                            let storeId = parts[0];
                            let branchId = parts[1];
                            let computerId = parts[2];
                            let key = `${storeId}_${branchId}_${computerId}`;
                            
                            if (computersMap.has(key)) {
                                computersMap.get(key).mouseMoves++;
                            }
                        }
                    });
                    
                    $scope.computersData = Array.from(computersMap.values());
                    $scope.processStoresData();
                } catch (error) {
                    console.error('Error processing computers data:', error);
                    $scope.computersData = [];
                }
            };
            
            // Process stores data
            $scope.processStoresData = function() {
                try {
                    if (!$scope.computersData || $scope.computersData.length === 0) {
                        $scope.storesData = [];
                        $scope.filteredStoresData = [];
                        return;
                    }
                    
                    const storesMap = new Map();
                    
                    $scope.computersData.forEach(computer => {
                        if (!storesMap.has(computer.storeId)) {
                            storesMap.set(computer.storeId, {
                                storeId: computer.storeId,
                                totalComputers: 0,
                                activeComputers: 0,
                                inactiveComputers: 0,
                                activePercentage: 0
                            });
                        }
                        
                        let store = storesMap.get(computer.storeId);
                        store.totalComputers++;
                        
                        if ($scope.isComputerActive(computer)) {
                            store.activeComputers++;
                        } else {
                            store.inactiveComputers++;
                        }
                    });
                    
                    // Calculate percentages
                    storesMap.forEach(store => {
                        store.activePercentage = store.totalComputers > 0 ? 
                            Math.round((store.activeComputers / store.totalComputers) * 100) : 0;
                    });
                    
                    $scope.storesData = Array.from(storesMap.values());
                    $scope.applyFilters();
                } catch (error) {
                    console.error('Error processing stores data:', error);
                    $scope.storesData = [];
                    $scope.filteredStoresData = [];
                }
            };
            
            // Get unique stores
            $scope.getUniqueStores = function() {
                if (!$scope.storesData) return [];
                return $scope.storesData.map(store => store.storeId).sort();
            };
            
            // Apply filters
            $scope.applyFilters = function() {
                if (!$scope.storesData) {
                    $scope.filteredStoresData = [];
                    return;
                }
                
                $scope.filteredStoresData = $scope.storesData.filter(store => {
                    let matches = true;
                    
                    if ($scope.storeFilter && store.storeId != $scope.storeFilter) {
                        matches = false;
                    }
                    
                    if ($scope.computerStatusFilter === 'active' && store.activeComputers === 0) {
                        matches = false;
                    }
                    
                    if ($scope.computerStatusFilter === 'inactive' && store.activeComputers > 0) {
                        matches = false;
                    }
                    
                    return matches;
                });
            };
            
            // Clear filters
            $scope.clearFilters = function() {
                $scope.storeFilter = '';
                $scope.computerStatusFilter = '';
                $scope.applyFilters();
            };
            
            // Sorting
            $scope.sortBy = function(field) {
                if ($scope.sortField === field) {
                    $scope.sortReverse = !$scope.sortReverse;
                } else {
                    $scope.sortField = field;
                    $scope.sortReverse = false;
                }
            };
            
            // Statistics functions
            $scope.getTotalStores = function() {
                return $scope.filteredStoresData ? $scope.filteredStoresData.length : 0;
            };
            
            $scope.getTotalActiveComputers = function() {
                if (!$scope.filteredStoresData) return 0;
                return $scope.filteredStoresData.reduce((sum, store) => sum + store.activeComputers, 0);
            };
            
            $scope.getTotalInactiveComputers = function() {
                if (!$scope.filteredStoresData) return 0;
                return $scope.filteredStoresData.reduce((sum, store) => sum + store.inactiveComputers, 0);
            };
            
            $scope.getAverageActiveComputersPerStore = function() {
                if (!$scope.filteredStoresData || $scope.filteredStoresData.length === 0) return 0;
                const totalActive = $scope.getTotalActiveComputers();
                return Math.round((totalActive / $scope.filteredStoresData.length) * 10) / 10;
            };
            
            $scope.getFilteredStoresCount = function() {
                return $scope.filteredStoresData ? $scope.filteredStoresData.length : 0;
            };
            
            $scope.getFilteredActiveComputersCount = function() {
                return $scope.getTotalActiveComputers();
            };
            
            // Get store computers
            $scope.getStoreComputers = function(storeId) {
                if (!$scope.computersData) return [];
                return $scope.computersData.filter(computer => computer.storeId === storeId);
            };
            
            // Show store details
            $scope.showStoreDetails = function(storeId) {
                $scope.selectedStoreId = storeId;
                $('#storeDetailsModal').modal('show');
            };
            
            // Refresh data
            $scope.refreshData = function() {
                // Clear all storage to force fresh data load
                localStorage.removeItem('actionsData');
                sessionStorage.removeItem('actionsData');
                
                // Clear chunks
                const chunks = localStorage.getItem('actionsData_chunks');
                if (chunks) {
                    const numChunks = parseInt(chunks);
                    for (let i = 0; i < numChunks; i++) {
                        localStorage.removeItem(`actionsData_chunk_${i}`);
                    }
                    localStorage.removeItem('actionsData_chunks');
                }
                
                $scope.loadData();
            };
            
            // Export to Excel
            $scope.exportToExcel = function() {
                try {
                    const data = $scope.filteredStoresData.map(store => ({
                        'חנות': $scope.getStoreName(store.storeId),
                        'סך מחשבים': store.totalComputers,
                        'מחשבים פעילים': store.activeComputers,
                        'מחשבים לא פעילים': store.inactiveComputers,
                        'אחוז פעילות': store.activePercentage + '%'
                    }));
                    
                    const ws = XLSX.utils.json_to_sheet(data);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, 'דוח מחשבים פעילים');
                    
                    const fileName = `דוח_מחשבים_פעילים_לפי_חנות_${new Date().toISOString().split('T')[0]}.xlsx`;
                    XLSX.writeFile(wb, fileName);
                } catch (error) {
                    console.error('Error exporting to Excel:', error);
                    alert('שגיאה בייצוא הקובץ');
                }
            };
            
            // Load data from sessionStorage, localStorage chunks, or API
            $scope.loadData = function() {
                // Try to get data from sessionStorage first (larger quota)
                let storedActions = sessionStorage.getItem('actionsData');
                
                if (storedActions) {
                    try {
                        $scope.actions = JSON.parse(storedActions);
                        console.log('Loaded actions from sessionStorage:', $scope.actions.length);
                        $scope.processComputersData();
                        return;
                    } catch (error) {
                        console.error('Error parsing stored actions from sessionStorage:', error);
                    }
                }
                
                // Try to get data from localStorage chunks
                const chunks = localStorage.getItem('actionsData_chunks');
                if (chunks) {
                    try {
                        const numChunks = parseInt(chunks);
                        let dataString = '';
                        
                        for (let i = 0; i < numChunks; i++) {
                            const chunk = localStorage.getItem(`actionsData_chunk_${i}`);
                            if (chunk) {
                                dataString += chunk;
                            }
                        }
                        
                        if (dataString) {
                            $scope.actions = JSON.parse(dataString);
                            console.log('Loaded actions from localStorage chunks:', $scope.actions.length);
                            $scope.processComputersData();
                            return;
                        }
                    } catch (error) {
                        console.error('Error parsing stored actions from chunks:', error);
                    }
                }
                
                // Try to get data from localStorage (old method)
                storedActions = localStorage.getItem('actionsData');
                if (storedActions) {
                    try {
                        $scope.actions = JSON.parse(storedActions);
                        console.log('Loaded actions from localStorage:', $scope.actions.length);
                        $scope.processComputersData();
                        return;
                    } catch (error) {
                        console.error('Error parsing stored actions from localStorage:', error);
                    }
                }
                
                // If no stored data, try to load from API
                $scope.loadActionsFromAPI();
            };
            
            // Load actions from API (same as main app)
            $scope.loadActionsFromAPI = function() {
                $scope.loading = true;
                
                // Use the same API endpoint as the main app
                $http.post('https://ads.safer.link/api/actions', {
                    userName: 'demo', // You can make this configurable
                    password: 'demo'
                })
                .then(function(response) {
                    if (response.data && response.data.actions) {
                        $scope.actions = response.data.actions;
                        console.log('Loaded actions from API:', $scope.actions.length);
                        
                        // Store in localStorage for future use
                        localStorage.setItem('actionsData', JSON.stringify($scope.actions));
                    } else {
                        console.error('No actions data in response');
                        $scope.actions = [];
                    }
                })
                .catch(function(error) {
                    console.error('Error loading actions:', error);
                    $scope.actions = [];
                })
                .finally(function() {
                    $scope.loading = false;
                    $scope.processComputersData();
                });
            };
            
            // Initialize
            $scope.init = function() {
                $scope.loadStoresDatabase();
                $scope.loadData();
                
                // Hide loading overlay after data is loaded
                $scope.$watch('actions', function(newVal) {
                    if (newVal && newVal.length > 0) {
                        setTimeout(() => {
                            document.getElementById('loadingOverlay').style.display = 'none';
                        }, 500);
                    }
                });
                
                // Fallback to hide loading overlay after 5 seconds
                setTimeout(() => {
                    document.getElementById('loadingOverlay').style.display = 'none';
                }, 5000);
            };
            
            // Start the application
            $scope.init();
        });
    </script>
</body>
</html> 